---

  - name: Palo Alto Playbook
    hosts: paloalto
    gather_facts: false

    connection: local

    collections:
      - paloaltonetworks.panos

    # vars_file:
    #   - inventario/group_vars/vars.yml

    # vars:
    #   palo_provider: 
    #     username: svc_ansible
    #     password: Mudar@123
    #     api_key: LUFRPT1xR2ZJb3ZPVFVBSHBqL0FaMTBsakpick1yS3c9MkQ3cGJ3b1F6b1AvSzNjUlBYSDI4ZktvdVR0SSsycVpuUDY3UVI4N1pnSENGc2k1U01abUNObXBOY2NoSHo2UA==
    #     ip_address: 192.168.252.9

    tasks:

      - name: show vpn flow Before
        panos_op:
          provider: '{{ palo_provider }}'
          cmd: 'show vpn flow'
        register: vpn_flow
      - debug: var=vpn_flow.stdout_xml

      - name: Reset VPN
        panos_vpn_tunnel:
          provider: '{{ palo_provider }}'
          validate_certs: no
          state: reset
        delegate_to: localhost
        register: vpn_reset_result
      
      - name: Check if VPN reset was sucessful
        debug:
          var: vpn_reset_result
      
      # - name: test vpn
      #   panos_op:
      #     provider: '{{ palo_provider }}'
      #     cmd: 'test vpn ipsec-sa tunnel vpn_test_fw_lab'
      #   register: test_vpn
      # - debug: var=test_vpn.stdout_xml

      - name: show vpn flow After
        panos_op:
          provider: '{{ palo_provider }}'
          cmd: 'show vpn flow'
        register: vpn_flow_after
      - debug: var=vpn_flow_after.stdout_xml